{"version":3,"file":"parallelQueryExecutionContextBase.js","sourceRoot":"","sources":["../../src/queryExecutionContext/parallelQueryExecutionContextBase.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\nimport PriorityQueue from \"priorityqueuejs\";\nimport semaphore from \"semaphore\";\nimport { ClientContext } from \"../ClientContext\";\nimport { logger } from \"../common/logger\";\nimport { StatusCodes, SubStatusCodes } from \"../common/statusCodes\";\nimport { FeedOptions, Response } from \"../request\";\nimport { PartitionedQueryExecutionInfo } from \"../request/ErrorResponse\";\nimport { QueryRange } from \"../routing/QueryRange\";\nimport { SmartRoutingMapProvider } from \"../routing/smartRoutingMapProvider\";\nimport { CosmosHeaders } from \"./CosmosHeaders\";\nimport { DocumentProducer } from \"./documentProducer\";\nimport { ExecutionContext } from \"./ExecutionContext\";\nimport { getInitialHeader, mergeHeaders } from \"./headerUtils\";\n\n/** @hidden */\nconst log = logger(\"parallelQueryExecutionContextBase\");\n\n/** @hidden */\nexport enum ParallelQueryExecutionContextBaseStates {\n  started = \"started\",\n  inProgress = \"inProgress\",\n  ended = \"ended\"\n}\n\n/** @hidden */\nexport abstract class ParallelQueryExecutionContextBase implements ExecutionContext {\n  private err: any;\n  private state: any;\n  private static STATES = ParallelQueryExecutionContextBaseStates;\n  private routingProvider: SmartRoutingMapProvider;\n  protected sortOrders: any;\n  private requestContinuation: any;\n  private respHeaders: CosmosHeaders;\n  private orderByPQ: PriorityQueue<DocumentProducer>;\n  private sem: any;\n  private waitingForInternalExecutionContexts: number;\n  /**\n   * Provides the ParallelQueryExecutionContextBase.\n   * This is the base class that ParallelQueryExecutionContext and OrderByQueryExecutionContext will derive from.\n   *\n   * When handling a parallelized query, it instantiates one instance of\n   * DocumentProcuder per target partition key range and aggregates the result of each.\n   *\n   * @constructor ParallelQueryExecutionContext\n   * @param {ClientContext} clientContext        - The service endpoint to use to create the client.\n   * @param {string} collectionLink                - The Collection Link\n   * @param {FeedOptions} [options]                - Represents the feed options.\n   * @param {object} partitionedQueryExecutionInfo - PartitionedQueryExecutionInfo\n   * @ignore\n   */\n  constructor(\n    private clientContext: ClientContext,\n    private collectionLink: string,\n    private query: any, // TODO: any - It's not SQLQuerySpec\n    private options: FeedOptions,\n    private partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo\n  ) {\n    this.clientContext = clientContext;\n    this.collectionLink = collectionLink;\n    this.query = query;\n    this.options = options;\n    this.partitionedQueryExecutionInfo = partitionedQueryExecutionInfo;\n\n    this.err = undefined;\n    this.state = ParallelQueryExecutionContextBase.STATES.started;\n    this.routingProvider = new SmartRoutingMapProvider(this.clientContext);\n    this.sortOrders = this.partitionedQueryExecutionInfo.queryInfo.orderBy;\n\n    this.requestContinuation = options ? options.continuationToken || options.continuation : null;\n    // response headers of undergoing operation\n    this.respHeaders = getInitialHeader();\n\n    // Make priority queue for documentProducers\n    // The comparator is supplied by the derived class\n    this.orderByPQ = new PriorityQueue<DocumentProducer>(\n      (a: DocumentProducer, b: DocumentProducer) => this.documentProducerComparator(b, a)\n    );\n    // Creating the documentProducers\n    this.sem = semaphore(1);\n    // Creating callback for semaphore\n    // TODO: Code smell\n    const createDocumentProducersAndFillUpPriorityQueueFunc = async () => {\n      // ensure the lock is released after finishing up\n      try {\n        const targetPartitionRanges = await this._onTargetPartitionRanges();\n        this.waitingForInternalExecutionContexts = targetPartitionRanges.length;\n\n        const maxDegreeOfParallelism =\n          options.maxDegreeOfParallelism === undefined || options.maxDegreeOfParallelism < 1\n            ? targetPartitionRanges.length\n            : Math.min(options.maxDegreeOfParallelism, targetPartitionRanges.length);\n\n        log.info(\n          \"Query starting against \" +\n            targetPartitionRanges.length +\n            \" ranges with parallelism of \" +\n            maxDegreeOfParallelism\n        );\n\n        const parallelismSem = semaphore(maxDegreeOfParallelism);\n        let filteredPartitionKeyRanges = [];\n        // The document producers generated from filteredPartitionKeyRanges\n        const targetPartitionQueryExecutionContextList: DocumentProducer[] = [];\n\n        if (this.requestContinuation) {\n          throw new Error(\"Continuation tokens are not yet supported for cross partition queries\");\n        } else {\n          filteredPartitionKeyRanges = targetPartitionRanges;\n        }\n\n        // Create one documentProducer for each partitionTargetRange\n        filteredPartitionKeyRanges.forEach((partitionTargetRange: any) => {\n          // TODO: any partitionTargetRange\n          // no async callback\n          targetPartitionQueryExecutionContextList.push(\n            this._createTargetPartitionQueryExecutionContext(partitionTargetRange)\n          );\n        });\n\n        // Fill up our priority queue with documentProducers\n        targetPartitionQueryExecutionContextList.forEach((documentProducer) => {\n          // has async callback\n          const throttledFunc = async () => {\n            try {\n              const { result: document, headers } = await documentProducer.current();\n              this._mergeWithActiveResponseHeaders(headers);\n              if (document === undefined) {\n                // no results on this one\n                return;\n              }\n              // if there are matching results in the target ex range add it to the priority queue\n              try {\n                this.orderByPQ.enq(documentProducer);\n              } catch (e) {\n                this.err = e;\n              }\n            } catch (err) {\n              this._mergeWithActiveResponseHeaders(err.headers);\n              this.err = err;\n            } finally {\n              parallelismSem.leave();\n              this._decrementInitiationLock();\n            }\n          };\n          parallelismSem.take(throttledFunc);\n        });\n      } catch (err) {\n        this.err = err;\n        // release the lock\n        this.sem.leave();\n        return;\n      }\n    };\n    this.sem.take(createDocumentProducersAndFillUpPriorityQueueFunc);\n  }\n\n  protected abstract documentProducerComparator(\n    dp1: DocumentProducer,\n    dp2: DocumentProducer\n  ): number;\n\n  private _decrementInitiationLock() {\n    // decrements waitingForInternalExecutionContexts\n    // if waitingForInternalExecutionContexts reaches 0 releases the semaphore and changes the state\n    this.waitingForInternalExecutionContexts = this.waitingForInternalExecutionContexts - 1;\n    if (this.waitingForInternalExecutionContexts === 0) {\n      this.sem.leave();\n      if (this.orderByPQ.size() === 0) {\n        this.state = ParallelQueryExecutionContextBase.STATES.inProgress;\n      }\n    }\n  }\n\n  private _mergeWithActiveResponseHeaders(headers: CosmosHeaders) {\n    mergeHeaders(this.respHeaders, headers);\n  }\n\n  private _getAndResetActiveResponseHeaders() {\n    const ret = this.respHeaders;\n    this.respHeaders = getInitialHeader();\n    return ret;\n  }\n\n  private async _onTargetPartitionRanges() {\n    // invokes the callback when the target partition ranges are ready\n    const parsedRanges = this.partitionedQueryExecutionInfo.queryRanges;\n    const queryRanges = parsedRanges.map((item) => QueryRange.parseFromDict(item));\n    return this.routingProvider.getOverlappingRanges(this.collectionLink, queryRanges);\n  }\n\n  /**\n   * Gets the replacement ranges for a partitionkeyrange that has been split\n   * @memberof ParallelQueryExecutionContextBase\n   * @instance\n   */\n  private async _getReplacementPartitionKeyRanges(documentProducer: DocumentProducer) {\n    const partitionKeyRange = documentProducer.targetPartitionKeyRange;\n    // Download the new routing map\n    this.routingProvider = new SmartRoutingMapProvider(this.clientContext);\n    // Get the queryRange that relates to this partitionKeyRange\n    const queryRange = QueryRange.parsePartitionKeyRange(partitionKeyRange);\n    return this.routingProvider.getOverlappingRanges(this.collectionLink, [queryRange]);\n  }\n\n  // TODO: P0 Code smell - can barely tell what this is doing\n  /**\n   * Removes the current document producer from the priqueue,\n   * replaces that document producer with child document producers,\n   * then reexecutes the originFunction with the corrrected executionContext\n   * @memberof ParallelQueryExecutionContextBase\n   * @instance\n   */\n  private async _repairExecutionContext(originFunction: any) {\n    // TODO: any\n    // Get the replacement ranges\n    // Removing the invalid documentProducer from the orderByPQ\n    const parentDocumentProducer = this.orderByPQ.deq();\n    try {\n      const replacementPartitionKeyRanges: any[] = await this._getReplacementPartitionKeyRanges(\n        parentDocumentProducer\n      );\n      const replacementDocumentProducers: DocumentProducer[] = [];\n      // Create the replacement documentProducers\n      replacementPartitionKeyRanges.forEach((partitionKeyRange) => {\n        // Create replacment document producers with the parent's continuationToken\n        const replacementDocumentProducer = this._createTargetPartitionQueryExecutionContext(\n          partitionKeyRange,\n          parentDocumentProducer.continuationToken\n        );\n        replacementDocumentProducers.push(replacementDocumentProducer);\n      });\n      // We need to check if the documentProducers even has anything left to fetch from before enqueing them\n      const checkAndEnqueueDocumentProducer = async (\n        documentProducerToCheck: DocumentProducer,\n        checkNextDocumentProducerCallback: any\n      ) => {\n        try {\n          const { result: afterItem } = await documentProducerToCheck.current();\n          if (afterItem === undefined) {\n            // no more results left in this document producer, so we don't enqueue it\n          } else {\n            // Safe to put document producer back in the queue\n            this.orderByPQ.enq(documentProducerToCheck);\n          }\n\n          await checkNextDocumentProducerCallback();\n        } catch (err) {\n          this.err = err;\n          return;\n        }\n      };\n      const checkAndEnqueueDocumentProducers = async (rdp: DocumentProducer[]) => {\n        if (rdp.length > 0) {\n          // We still have a replacementDocumentProducer to check\n          const replacementDocumentProducer = rdp.shift();\n          await checkAndEnqueueDocumentProducer(replacementDocumentProducer, async () => {\n            await checkAndEnqueueDocumentProducers(rdp);\n          });\n        } else {\n          // reexecutes the originFunction with the corrrected executionContext\n          return originFunction();\n        }\n      };\n      // Invoke the recursive function to get the ball rolling\n      await checkAndEnqueueDocumentProducers(replacementDocumentProducers);\n    } catch (err) {\n      this.err = err;\n      throw err;\n    }\n  }\n\n  private static _needPartitionKeyRangeCacheRefresh(error: any) {\n    // TODO: any error\n    return (\n      error.code === StatusCodes.Gone &&\n      \"substatus\" in error &&\n      error[\"substatus\"] === SubStatusCodes.PartitionKeyRangeGone\n    );\n  }\n\n  /**\n   * Checks to see if the executionContext needs to be repaired.\n   * if so it repairs the execution context and executes the ifCallback,\n   * else it continues with the current execution context and executes the elseCallback\n   * @memberof ParallelQueryExecutionContextBase\n   * @instance\n   */\n  private async _repairExecutionContextIfNeeded(ifCallback: any, elseCallback: any) {\n    const documentProducer = this.orderByPQ.peek();\n    // Check if split happened\n    try {\n      await documentProducer.current();\n      elseCallback();\n    } catch (err) {\n      if (ParallelQueryExecutionContextBase._needPartitionKeyRangeCacheRefresh(err)) {\n        // Split has happened so we need to repair execution context before continueing\n        return this._repairExecutionContext(ifCallback);\n      } else {\n        // Something actually bad happened ...\n        this.err = err;\n        throw err;\n      }\n    }\n  }\n\n  /**\n   * Execute a provided function on the next element in the ParallelQueryExecutionContextBase.\n   * @memberof ParallelQueryExecutionContextBase\n   * @instance\n   * @param {callback} callback - Function to execute for each element. the function takes two \\\n   * parameters error, element.\n   */\n  public async nextItem(): Promise<Response<any>> {\n    if (this.err) {\n      // if there is a prior error return error\n      throw this.err;\n    }\n    return new Promise<Response<any>>((resolve, reject) => {\n      this.sem.take(() => {\n        // NOTE: lock must be released before invoking quitting\n        if (this.err) {\n          // release the lock before invoking callback\n          this.sem.leave();\n          // if there is a prior error return error\n          this.err.headers = this._getAndResetActiveResponseHeaders();\n          reject(this.err);\n          return;\n        }\n\n        if (this.orderByPQ.size() === 0) {\n          // there is no more results\n          this.state = ParallelQueryExecutionContextBase.STATES.ended;\n          // release the lock before invoking callback\n          this.sem.leave();\n          return resolve({\n            result: undefined,\n            headers: this._getAndResetActiveResponseHeaders()\n          });\n        }\n\n        const ifCallback = () => {\n          // Release the semaphore to avoid deadlock\n          this.sem.leave();\n          // Reexcute the function\n          return resolve(this.nextItem());\n        };\n        const elseCallback = async () => {\n          let documentProducer: DocumentProducer;\n          try {\n            documentProducer = this.orderByPQ.deq();\n          } catch (e) {\n            // if comparing elements of the priority queue throws exception\n            // set that error and return error\n            this.err = e;\n            // release the lock before invoking callback\n            this.sem.leave();\n            this.err.headers = this._getAndResetActiveResponseHeaders();\n            reject(this.err);\n            return;\n          }\n\n          let item: any;\n          let headers: CosmosHeaders;\n          try {\n            const response = await documentProducer.nextItem();\n            item = response.result;\n            headers = response.headers;\n            this._mergeWithActiveResponseHeaders(headers);\n            if (item === undefined) {\n              // this should never happen\n              // because the documentProducer already has buffered an item\n              // assert item !== undefined\n              this.err = new Error(\n                `Extracted DocumentProducer from the priority queue \\\n                                            doesn't have any buffered item!`\n              );\n              // release the lock before invoking callback\n              this.sem.leave();\n              return resolve({\n                result: undefined,\n                headers: this._getAndResetActiveResponseHeaders()\n              });\n            }\n          } catch (err) {\n            this.err = new Error(\n              `Extracted DocumentProducer from the priority queue fails to get the \\\n                                    buffered item. Due to ${JSON.stringify(err)}`\n            );\n            this.err.headers = this._getAndResetActiveResponseHeaders();\n            // release the lock before invoking callback\n            this.sem.leave();\n            reject(this.err);\n            return;\n          }\n\n          // we need to put back the document producer to the queue if it has more elements.\n          // the lock will be released after we know document producer must be put back in the queue or not\n          try {\n            const { result: afterItem, headers: otherHeaders } = await documentProducer.current();\n            this._mergeWithActiveResponseHeaders(otherHeaders);\n            if (afterItem === undefined) {\n              // no more results is left in this document producer\n            } else {\n              try {\n                const headItem = documentProducer.fetchResults[0];\n                if (typeof headItem === \"undefined\") {\n                  throw new Error(\n                    \"Extracted DocumentProducer from PQ is invalid state with no result!\"\n                  );\n                }\n                this.orderByPQ.enq(documentProducer);\n              } catch (e) {\n                // if comparing elements in priority queue throws exception\n                // set error\n                this.err = e;\n              }\n            }\n          } catch (err) {\n            if (ParallelQueryExecutionContextBase._needPartitionKeyRangeCacheRefresh(err)) {\n              // We want the document producer enqueued\n              // So that later parts of the code can repair the execution context\n              this.orderByPQ.enq(documentProducer);\n            } else {\n              // Something actually bad happened\n              this.err = err;\n              reject(this.err);\n            }\n          } finally {\n            // release the lock before returning\n            this.sem.leave();\n          }\n          // invoke the callback on the item\n          return resolve({\n            result: item,\n            headers: this._getAndResetActiveResponseHeaders()\n          });\n        };\n        this._repairExecutionContextIfNeeded(ifCallback, elseCallback).catch(reject);\n      });\n    });\n  }\n\n  /**\n   * Determine if there are still remaining resources to processs based on the value of the continuation \\\n   * token or the elements remaining on the current batch in the QueryIterator.\n   * @memberof ParallelQueryExecutionContextBase\n   * @instance\n   * @returns {Boolean} true if there is other elements to process in the ParallelQueryExecutionContextBase.\n   */\n  public hasMoreResults() {\n    return !(\n      this.state === ParallelQueryExecutionContextBase.STATES.ended || this.err !== undefined\n    );\n  }\n\n  /**\n   * Creates document producers\n   */\n  private _createTargetPartitionQueryExecutionContext(\n    partitionKeyTargetRange: any,\n    continuationToken?: any\n  ) {\n    // TODO: any\n    // creates target partition range Query Execution Context\n    let rewrittenQuery = this.partitionedQueryExecutionInfo.queryInfo.rewrittenQuery;\n    let query = this.query;\n    if (typeof query === \"string\") {\n      query = { query };\n    }\n\n    const formatPlaceHolder = \"{documentdb-formattableorderbyquery-filter}\";\n    if (rewrittenQuery) {\n      query = JSON.parse(JSON.stringify(query));\n      // We hardcode the formattable filter to true for now\n      rewrittenQuery = rewrittenQuery.replace(formatPlaceHolder, \"true\");\n      query[\"query\"] = rewrittenQuery;\n    }\n\n    const options = JSON.parse(JSON.stringify(this.options));\n    options.continuationToken = continuationToken;\n\n    return new DocumentProducer(\n      this.clientContext,\n      this.collectionLink,\n      query,\n      partitionKeyTargetRange,\n      options\n    );\n  }\n}\n"]}